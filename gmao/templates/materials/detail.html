{% extends 'layout.html' %}
{% block title %}{{ material.designation }} - Matériel{% endblock %}
{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h3 mb-0">{{ material.designation }}</h1>
    <p class="text-muted mb-0">PN {{ material.part_number or 'N/A' }} · Catégorie {{ material.category }}</p>
  </div>
  <div class="btn-group">
    <a class="btn btn-secondary" href="{{ url_for('materials.index') }}">Retour</a>
    <form class="d-inline" method="post" action="{{ url_for('materials.delete', material_id=material.id) }}" onsubmit="return confirm('Supprimer ce matériel et ses liaisons ?');">
      <button class="btn btn-outline-danger" type="submit">Supprimer</button>
    </form>
  </div>
</div>
{% endblock %}
{% block page_content %}
<div class="row g-3">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h2 class="h5 mb-0">Données logistiques</h2>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('materials.update', material_id=material.id) }}">
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">Désignation</label>
              <input class="form-control" name="designation" value="{{ material.designation }}" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">PN</label>
              <input class="form-control" name="part_number" value="{{ material.part_number or '' }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">SN</label>
              <input class="form-control" name="serial_number" value="{{ material.serial_number or '' }}">
            </div>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <label class="form-label">Catégorie</label>
              <select class="form-select" name="category" required>
                {% for option in ['reparable','consommable','outillage','banc d\'essai'] %}
                  <option value="{{ option }}" {% if material.category == option %}selected{% endif %}>{{ option|capitalize }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Qté / avion</label>
              <input class="form-control" type="number" min="0" name="per_aircraft" value="{{ material.per_aircraft }}">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="warranty" id="warrantyToggle" {% if material.warranty %}checked{% endif %}>
                <label class="form-check-label" for="warrantyToggle">Sous garantie</label>
              </div>
            </div>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">NSN</label>
              <input class="form-control" name="nsn" value="{{ material.nsn or '' }}" maxlength="30" placeholder="1234-00-123-4567">
              <div class="form-text">13 caractères, format classique 4-2-3-4.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">NIIN</label>
              <input class="form-control" name="niin" value="{{ material.niin or '' }}" maxlength="30" placeholder="00-123-4567">
              <div class="form-text">9 chiffres (y compris code pays) ou laissez vide.</div>
            </div>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">FSC</label>
              <input class="form-control" name="fsc" value="{{ material.fsc or '' }}" maxlength="20" placeholder="1234">
              <div class="form-text">4 chiffres pour la classe fédérale d'approvisionnement.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Code CAGE</label>
              <input class="form-control" name="cage_code" value="{{ material.cage_code or '' }}" maxlength="30" placeholder="1A234">
              <div class="form-text">5 caractères alphanumériques identifiant le fournisseur.</div>
            </div>
          </div>
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <label class="form-label">Référence DA</label>
              <input class="form-control" name="da_reference" value="{{ material.da_reference or '' }}" maxlength="80" placeholder="DA-2024-00123">
              <div class="form-text">Numéro de la demande d'achat (laisser vide pour supprimer).</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Statut DA</label>
              <input class="form-control" name="da_status" value="{{ material.da_status or '' }}" maxlength="80" placeholder="En cours">
              <div class="form-text">Ex. &laquo;&nbsp;En cours&nbsp;&raquo;, &laquo;&nbsp;Validé&nbsp;&raquo;, etc.</div>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">Type de contrat</label>
            <input class="form-control" name="contract_type" value="{{ material.contract_type or '' }}" maxlength="50" placeholder="FMS / MCO">
            <div class="form-text">Catégorie contractuelle (laisser vide si non applicable).</div>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Dotation</label>
              <input class="form-control" type="number" name="dotation" value="{{ material.dotation }}">
            </div>
            <div class="col">
              <label class="form-label">Stock</label>
              <input class="form-control" type="number" name="stock" value="{{ material.stock }}">
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col">
              <label class="form-label">Avionnée</label>
              <input class="form-control" type="number" name="avionnee" value="{{ material.avionnee }}">
            </div>
            <div class="col">
              <label class="form-label">Indispo attente réparation</label>
              <input class="form-control" type="number" name="unavailable_for_repair" value="{{ material.unavailable_for_repair }}">
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col">
              <label class="form-label">En réparation</label>
              <input class="form-control" type="number" name="in_repair" value="{{ material.in_repair }}">
            </div>
            <div class="col">
              <label class="form-label">Litige</label>
              <input class="form-control" type="number" name="litigation" value="{{ material.litigation }}">
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col">
              <label class="form-label">Réforme</label>
              <input class="form-control" type="number" name="scrapped" value="{{ material.scrapped }}">
            </div>
            <div class="col">
              <label class="form-label">Consommation annuelle</label>
              <input class="form-control" type="number" name="annual_consumption" value="{{ material.annual_consumption }}">
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col">
              <label class="form-label">Stock consommable</label>
              <input class="form-control" type="number" name="consumable_stock" value="{{ material.consumable_stock }}">
            </div>
            <div class="col">
              <label class="form-label">Dotation consommable</label>
              <input class="form-control" type="number" name="consumable_dotation" value="{{ material.consumable_dotation }}">
            </div>
          </div>
          <div class="mb-3 mt-2">
            <label class="form-label">Type consommable</label>
            <input class="form-control" name="consumable_type" value="{{ material.consumable_type or '' }}">
          </div>
          <button class="btn btn-primary" type="submit">Sauvegarder</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h2 class="h5 mb-0">Besoins par tâches</h2>
      </div>
      <div class="card-body">
        {% if requirements %}
          <ul class="list-group list-group-flush">
            {% for req in requirements %}
              <li class="list-group-item">
                <div class="d-flex justify-content-between">
                  <span>{{ req.task.visit.name }} · {{ req.task.name }}</span>
                  <span class="badge bg-primary">{{ req.quantity }}</span>
                </div>
                <small class="text-muted">Atelier {{ req.task.workshop.name if req.task.workshop else 'N/A' }}</small>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">Pas de besoin en cours.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
