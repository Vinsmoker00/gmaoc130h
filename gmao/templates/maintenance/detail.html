{% extends 'layout.html' %}
{% block title %}{{ visit.name }} - Visite{% endblock %}
{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h3 mb-0">{{ visit.name }} · {{ visit.aircraft.tail_number }}</h1>
    <p class="text-muted mb-0">Type {{ visit.vp_type }} · {{ visit.status }}</p>
  </div>
  <a class="btn btn-secondary" href="{{ url_for('maintenance.index') }}">Retour liste</a>
</div>
{% endblock %}
{% block page_content %}
<div class="row g-3">
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h2 class="h5 mb-0">Résumé</h2>
      </div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-5">Début</dt>
          <dd class="col-7">{{ visit.start_date.strftime('%d/%m/%Y') }}</dd>
          <dt class="col-5">Fin prévue</dt>
          <dd class="col-7">{% if visit.end_date %}{{ visit.end_date.strftime('%d/%m/%Y') }}{% else %}Non définie{% endif %}</dd>
          <dt class="col-5">Personnel engagé</dt>
          <dd class="col-7">{{ visit.active_personnel()|length }}</dd>
          <dt class="col-5">Tâches</dt>
          <dd class="col-7">{{ visit.tasks.count() }}</dd>
        </dl>
      </div>
    </div>
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-white">
        <h2 class="h5 mb-0">Nouvelle tâche</h2>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('maintenance.add_task', visit_id=visit.id) }}">
          <div class="mb-3">
            <label class="form-label">Nom</label>
            <input class="form-control" name="name" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Atelier</label>
            <select class="form-select" name="workshop_id">
              <option value="">Non assigné</option>
              {% for workshop in workshops %}
                <option value="{{ workshop.id }}">{{ workshop.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Chef d'équipe</label>
            <select class="form-select" name="lead_id">
              <option value="">Non assigné</option>
              {% for person in personnel %}
                <option value="{{ person.id }}">{{ person.full_name }} ({{ person.rank }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Heures estimées</label>
            <input class="form-control" type="number" step="0.5" name="estimated_hours" value="0">
          </div>
          <div class="mb-3">
            <label class="form-label">Statut</label>
            <select class="form-select" name="status">
              <option value="pending">À planifier</option>
              <option value="in_progress">En cours</option>
              <option value="completed">Terminée</option>
            </select>
          </div>
          <button class="btn btn-primary" type="submit">Ajouter</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Tâches de la visite</h2>
        <span class="badge bg-primary">{{ visit.tasks.count() }} tâches</span>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Nom</th>
              <th>Atelier</th>
              <th>Chef</th>
              <th>Statut</th>
              <th>Heures</th>
              <th>Matériel</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for task in visit.tasks %}
              <tr>
                <td>{{ task.name }}</td>
                <td>{{ task.workshop.name if task.workshop else '—' }}</td>
                <td>{{ task.lead.full_name if task.lead else '—' }}</td>
                <td><span class="badge bg-secondary">{{ task.status }}</span></td>
                <td>{{ task.estimated_hours }}</td>
                <td>
                  {% if task.materials.count() %}
                    <ul class="list-unstyled mb-0">
                      {% for req in task.materials %}
                        <li>{{ req.material.designation }} · {{ req.quantity }}</li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#taskModal{{ task.id }}">Mettre à jour</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% for task in visit.tasks %}
<div class="modal fade" id="taskModal{{ task.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ task.name }}</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form class="mb-4" method="post" action="{{ url_for('maintenance.update_task_status', task_id=task.id) }}">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Statut</label>
              <select class="form-select" name="status">
                {% for option in ['pending','in_progress','completed','suspended'] %}
                  <option value="{{ option }}" {% if task.status == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Début</label>
              <input class="form-control" type="datetime-local" name="started_at" value="{{ task.started_at.isoformat(timespec='minutes') if task.started_at else '' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Fin</label>
              <input class="form-control" type="datetime-local" name="completed_at" value="{{ task.completed_at.isoformat(timespec='minutes') if task.completed_at else '' }}">
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Cause d'interruption</label>
            <textarea class="form-control" name="interruption_reason" rows="2">{{ task.interruption_reason }}</textarea>
          </div>
          <div class="mt-3 text-end">
            <button class="btn btn-primary" type="submit">Sauvegarder</button>
          </div>
        </form>
        <form method="post" action="{{ url_for('maintenance.update_task_materials', task_id=task.id) }}">
          <div class="row g-2 align-items-end">
            <div class="col-md-6">
              <label class="form-label">Matériel requis</label>
              <select class="form-select" name="material_id" required>
                {% for material in materials %}
                  <option value="{{ material.id }}">{{ material.designation }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Quantité</label>
              <input class="form-control" type="number" min="1" name="quantity" value="1">
            </div>
            <div class="col-md-3 text-end">
              <button class="btn btn-outline-primary" type="submit">Mettre à jour</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}
