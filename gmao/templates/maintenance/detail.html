{% extends 'layout.html' %}
{% block title %}{{ visit.name }} - Visite{% endblock %}
{% block page_header %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h3 mb-0">{{ visit.name }} · {{ visit.aircraft.tail_number }}</h1>
    <p class="text-muted mb-0">Type {{ visit.vp_type }} · {{ visit.status }}</p>
  </div>
  <div class="btn-group">
    <a class="btn btn-secondary" href="{{ url_for('maintenance.index') }}">Retour liste</a>
    <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editVisitModal">Modifier</button>
    <form class="d-inline" method="post" action="{{ url_for('maintenance.delete_visit', visit_id=visit.id) }}" onsubmit="return confirm('Supprimer cette visite et toutes ses tâches ?');">
      <button class="btn btn-outline-danger" type="submit">Supprimer</button>
    </form>
  </div>
</div>
{% endblock %}
{% block page_content %}
<div class="row g-3">
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h2 class="h5 mb-0">Résumé</h2>
      </div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-5">Début</dt>
          <dd class="col-7">{{ visit.start_date.strftime('%d/%m/%Y') }}</dd>
          <dt class="col-5">Fin prévue</dt>
          <dd class="col-7">{% if visit.end_date %}{{ visit.end_date.strftime('%d/%m/%Y') }}{% else %}Non définie{% endif %}</dd>
          <dt class="col-5">Personnel engagé</dt>
          <dd class="col-7">{{ visit.active_personnel()|length }}</dd>
          <dt class="col-5">Tâches</dt>
          <dd class="col-7">{{ tasks|length }}</dd>
          <dt class="col-5">Périodicité</dt>
          <dd class="col-7">{% if periodicity_months %}{{ periodicity_months }} mois{% else %}—{% endif %}</dd>
        </dl>
      </div>
    </div>
    {% if package_codes %}
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Package SMP515</h2>
        <form method="post" action="{{ url_for('maintenance.sync_package', visit_id=visit.id) }}">
          <button class="btn btn-sm btn-outline-primary" type="submit">Synchroniser</button>
        </form>
      </div>
      <div class="card-body">
        <p class="mb-2">{{ package_status.completed }} terminées / {{ package_status.total }} prévues.</p>
        {% if package_status.missing %}
          <div class="alert alert-warning small">
            Job cards absentes de l'archive : {{ package_status.missing|join(', ') }}
          </div>
        {% endif %}
        <div class="table-responsive" style="max-height: 220px;">
          <table class="table table-sm align-middle mb-0">
            <thead>
              <tr>
                <th>Réf.</th>
                <th>Titre</th>
                <th>Statut</th>
              </tr>
            </thead>
            <tbody>
              {% for item in package_status.overview %}
                <tr>
                  <td class="fw-semibold">{{ item.code }}</td>
                  <td>
                    {% if item.job_card %}
                      {{ item.job_card.title }}
                    {% else %}
                      <span class="text-muted">À compléter</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if item.status == 'completed' %}
                      <span class="badge bg-success">Terminée</span>
                    {% elif item.status == 'missing' %}
                      <span class="badge bg-warning text-dark">À créer</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ item.status }}</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    {% endif %}
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-white">
        <h2 class="h5 mb-0">Nouvelle tâche</h2>
      </div>
      <div class="card-body">
        <form method="post" action="{{ url_for('maintenance.add_task', visit_id=visit.id) }}">
          <div class="mb-3">
            <label class="form-label">Job card</label>
            <select class="form-select" name="job_card_id">
              <option value="">Sans job card</option>
              {% for card in job_cards %}
                <option value="{{ card.id }}">{{ card.card_number }} · {{ card.title }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Sélectionnez une job card existante ou décrivez la tâche librement.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Description libre</label>
            <textarea class="form-control" name="description" rows="2" placeholder="Détail de la tâche ad hoc"></textarea>
            <div class="form-text">Obligatoire si aucune job card n'est choisie.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Atelier</label>
            <select class="form-select" name="workshop_id">
              <option value="">Non assigné</option>
              {% for workshop in workshops %}
                <option value="{{ workshop.id }}">{{ workshop.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Chef d'équipe</label>
            <select class="form-select" name="lead_id">
              <option value="">Non assigné</option>
              {% for person in personnel %}
                <option value="{{ person.id }}">{{ person.full_name }} ({{ person.rank }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Heures estimées</label>
            <input class="form-control" type="number" step="0.5" name="estimated_hours" value="0">
          </div>
          <div class="mb-3">
            <label class="form-label">Statut</label>
            <select class="form-select" name="status">
              <option value="pending">À planifier</option>
              <option value="in_progress">En cours</option>
              <option value="completed">Terminée</option>
            </select>
          </div>
          <button class="btn btn-primary" type="submit">Ajouter</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Tâches de la visite</h2>
        <span class="badge bg-primary">{{ tasks|length }} tâches</span>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>Tâche</th>
              <th>Job card</th>
              <th>Atelier</th>
              <th>Chef</th>
              <th>Statut</th>
              <th>Heures</th>
              <th>Matériel</th>
              <th>Origine</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
              <tr>
                <td>{{ task.name }}</td>
                <td>
                  {% if task.job_card %}
                    <div class="fw-semibold">{{ task.job_card.card_number }}</div>
                    <div class="text-muted small">{{ task.job_card.title }}</div>
                  {% elif task.package_code %}
                    <div class="fw-semibold">{{ task.package_code }}</div>
                    <div class="text-muted small">Job card à renseigner</div>
                  {% else %}
                    <span class="badge bg-light text-dark">Ad hoc</span>
                  {% endif %}
                </td>
                <td>{{ task.workshop.name if task.workshop else '—' }}</td>
                <td>{{ task.lead.full_name if task.lead else '—' }}</td>
                <td><span class="badge bg-secondary">{{ task.status }}</span></td>
                <td>{{ task.estimated_hours }}</td>
                <td>
                  {% if task.materials.count() %}
                    <ul class="list-unstyled mb-0">
                      {% for req in task.materials %}
                        <li class="d-flex justify-content-between align-items-center">
                          <span>{{ req.material.designation }} · {{ req.quantity }}</span>
                          <form method="post" action="{{ url_for('maintenance.delete_task_material', requirement_id=req.id) }}" class="ms-2">
                            <button class="btn btn-link btn-sm text-danger p-0" type="submit">Retirer</button>
                          </form>
                        </li>
                      {% endfor %}
                    </ul>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td>
                  {% if task.is_package_item %}
                    <span class="badge bg-info text-dark">Package</span>
                  {% else %}
                    <span class="badge bg-light text-dark">Complément</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#taskModal{{ task.id }}">Mettre à jour</button>
                    <form class="d-inline" method="post" action="{{ url_for('maintenance.delete_task', task_id=task.id) }}" onsubmit="return confirm('Supprimer définitivement cette tâche ?');">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Supprimer</button>
                    </form>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
    </div>
  </div>
  {% if material_totals %}
  <div class="card shadow-sm mt-3">
    <div class="card-header bg-white">
      <h2 class="h5 mb-0">Synthèse matériel</h2>
    </div>
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead>
          <tr>
            <th>Désignation</th>
            <th>Package</th>
            <th>Compléments</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          {% for item in material_totals %}
            <tr>
              <td>{{ item.material.designation }}</td>
              <td>{{ item.job_card_quantity }}</td>
              <td>{{ item.additional_quantity }}</td>
              <td>{{ item.job_card_quantity + item.additional_quantity }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}
</div>
</div>
{% for task in tasks %}
<div class="modal fade" id="taskModal{{ task.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ task.name }}</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        {% if task.job_card %}
          <div class="alert alert-info d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">Job card {{ task.job_card.card_number }}</div>
              <div class="small">{{ task.job_card.title }}</div>
            </div>
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('archive.index', search=task.job_card.card_number) }}">Ouvrir l'archive</a>
          </div>
        {% endif %}
        <form class="mb-4" method="post" action="{{ url_for('maintenance.update_task', task_id=task.id) }}">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">Intitulé</label>
              <input class="form-control" name="name" value="{{ task.name }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Job card liée</label>
              <select class="form-select" name="job_card_id">
                <option value="">Sans</option>
                {% for card in job_cards %}
                  <option value="{{ card.id }}" {% if task.job_card_id == card.id %}selected{% endif %}>{{ card.card_number }} · {{ card.title }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-4">
              <label class="form-label">Atelier</label>
              <select class="form-select" name="workshop_id">
                <option value="">Non assigné</option>
                {% for workshop in workshops %}
                  <option value="{{ workshop.id }}" {% if task.workshop_id == workshop.id %}selected{% endif %}>{{ workshop.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Chef d'équipe</label>
              <select class="form-select" name="lead_id">
                <option value="">Non assigné</option>
                {% for person in personnel %}
                  <option value="{{ person.id }}" {% if task.lead_id == person.id %}selected{% endif %}>{{ person.full_name }} ({{ person.rank }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Heures estimées</label>
              <input class="form-control" type="number" step="0.5" name="estimated_hours" value="{{ task.estimated_hours }}">
            </div>
          </div>
          <div class="text-end mt-3">
            <button class="btn btn-primary" type="submit">Mettre à jour la tâche</button>
          </div>
        </form>
        <form class="mb-4" method="post" action="{{ url_for('maintenance.update_task_status', task_id=task.id) }}">
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Statut</label>
              <select class="form-select" name="status">
                {% for option in ['pending','in_progress','completed','suspended'] %}
                  <option value="{{ option }}" {% if task.status == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Début</label>
              <input class="form-control" type="datetime-local" name="started_at" value="{{ task.started_at.isoformat(timespec='minutes') if task.started_at else '' }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">Fin</label>
              <input class="form-control" type="datetime-local" name="completed_at" value="{{ task.completed_at.isoformat(timespec='minutes') if task.completed_at else '' }}">
            </div>
          </div>
          <div class="mt-3">
            <label class="form-label">Cause d'interruption</label>
            <textarea class="form-control" name="interruption_reason" rows="2">{{ task.interruption_reason }}</textarea>
          </div>
          <div class="mt-3 text-end">
            <button class="btn btn-primary" type="submit">Sauvegarder</button>
          </div>
        </form>
        <form method="post" action="{{ url_for('maintenance.update_task_materials', task_id=task.id) }}">
          <div class="row g-2 align-items-end">
            <div class="col-md-6">
              <label class="form-label">Matériel requis</label>
              <select class="form-select" name="material_id" required>
                {% for material in materials %}
                  <option value="{{ material.id }}">{{ material.designation }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Quantité</label>
              <input class="form-control" type="number" min="1" name="quantity" value="1">
            </div>
            <div class="col-md-3 text-end">
              <button class="btn btn-outline-primary" type="submit">Mettre à jour</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}
