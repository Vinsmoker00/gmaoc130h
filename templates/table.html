{% extends "base.html" %}
{% block content %}
  <h2 class="mb-4">Edit Job Card: {{ card_name }}</h2>

  <form id="reorderForm" method="post" action="{{ url_for('reorder_card', card_id=card_id) }}">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="table-responsive">
          <table id="jobTable" class="table table-bordered align-middle">
            <thead class="table-dark">
              <tr>
                <th style="width:40%">Paragraph</th>
                <th style="width:60%">Step</th>
              </tr>
            </thead>
            <tbody id="sortableTable">
              {% for row in table_data %}
                <tr class="draggable-row" data-paragraph="{{ row[0] }}" data-step="{{ row[1] }}">
                  <td>{{ row[0] }}</td>
                  <td>{{ row[1] }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-success mt-3">üíæ Save Order</button>
    <a href="{{ url_for('upload_file', card_id=card_id) }}" class="btn btn-secondary mt-3">Upload another PDF</a>
  </form>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  <script>
    // Enable drag & drop sorting
    new Sortable(document.getElementById("sortableTable"), {
      animation: 150,
      ghostClass: "sortable-ghost"
    });

    // On form submit, build JSON structure
    document.getElementById("reorderForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const rows = document.querySelectorAll("#sortableTable tr");
      let reordered = [];
      rows.forEach(r => {
        reordered.push({
          paragraph: r.dataset.paragraph,
          step: r.dataset.step
        });
      });

      fetch(this.action, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(reordered)
      }).then(resp => {
        if (resp.ok) {
          // Redirect to library with a success flash
          window.location.href = "{{ url_for('library') }}?updated=1";
        } else {
          alert("‚ùå Failed to update order.");
        }
      });
    });
  </script>

  <style>
    .sortable-ghost {
      opacity: 0.5;
      background: #ffeeba;
    }
    .draggable-row {
      cursor: grab;
    }
  </style>
{% endblock %}
