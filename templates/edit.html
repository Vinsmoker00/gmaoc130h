{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Editing Job Card: {{ card_name }}</h2>
  <div>
    <a class="btn btn-outline-secondary" href="{{ url_for('view_card', card_id=card_id) }}">View</a>
    <a class="btn btn-secondary" href="{{ url_for('library') }}">Library</a>
  </div>
</div>

<!-- PDF preview and meta editing -->
<div class="row mb-3">
  <div class="col-md-8">
    <h5>PDF Preview</h5>
    {% set card_pdf = request.args.get('pdf') or '' %}
    {% if card_pdf %}
      <iframe src="{{ card_pdf }}" style="width:100%;height:400px;border:1px solid #ddd;"></iframe>
    {% elif pdf_filename %}
      <iframe src="{{ url_for('uploaded_pdf', filename=pdf_filename) }}" style="width:100%;height:400px;border:1px solid #ddd;"></iframe>
    {% else %}
      <p class="text-muted">No PDF available.</p>
    {% endif %}
  </div>
  

  <div class="col-md-4">
    <h5>Card metadata</h5>
    <!-- Metadata form -->
    <form method="post" action="{{ url_for('save_card_meta', card_id=card_id) }}">
      <div class="mb-2">
        <label>Warnings</label>
        <textarea name="warnings" class="form-control" rows="3" 
                  style="max-height:120px; overflow-y:auto;">{{ warnings or '' }}</textarea>
      </div>
      <div class="mb-2">
        <label>Cautions</label>
        <textarea name="cautions" class="form-control" rows="3" 
                  style="max-height:120px; overflow-y:auto;">{{ cautions or '' }}</textarea>
      </div>
      <div class="mb-2">
        <label>Notes</label>
        <textarea name="notes" class="form-control" rows="3" 
                  style="max-height:120px; overflow-y:auto;">{{ notes or '' }}</textarea>
      </div>      
      <button class="btn btn-sm btn-success mt-2" type="submit">Save metadata</button>
    </form>
  
    <!-- PDF upload form (separate!) -->
    <h5 class="mt-4">Attach/Replace PDF</h5>
    <form method="post" action="{{ url_for('replace_card_pdf', card_id=card_id) }}" enctype="multipart/form-data">
      <input type="file" name="file" accept=".pdf" required>
      <button class="btn btn-sm btn-primary mt-2" type="submit">Upload PDF</button>
    </form>
  </div>
  
</div>

<!-- Editable structured editor -->
<div class="card mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between mb-2">
      <h5>Paragraphs & Steps</h5>
      <div>
        <button class="btn btn-sm btn-success" id="addParagraphBtn">+ Paragraph</button>
        <button class="btn btn-sm btn-primary" id="saveStructureBtn">ðŸ’¾ Save Structure</button>
      </div>
    </div>

    <div id="structureContainer">
      <!-- If job_data provided by backend, we will render it via JS using a JSON payload -->
    </div>
  </div>
</div>

<!-- attachments area (unchanged) -->
<div class="mt-2">
  <h5>Attached Drawings</h5>
  <div class="row">
    {% for att in attachments %}
      <div class="col-md-3 mb-3 text-center">
        {% if att[1].lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
          <img src="{{ url_for('uploaded_drawing', filename=att[1]) }}" class="img-fluid border rounded mb-2" alt="{{ att[1] }}">
        {% else %}
          <a href="{{ url_for('uploaded_drawing', filename=att[1]) }}" target="_blank">ðŸ“„ {{ att[1] }}</a>
        {% endif %}
        <form action="{{ url_for('replace_drawing', attachment_id=att[0], card_id=card_id) }}" method="post" enctype="multipart/form-data" class="mt-2">
          <input type="file" name="file" accept="image/*,.pdf" required>
          <button type="submit" class="btn btn-sm btn-warning mt-1">Replace</button>
        </form>
        <form action="{{ url_for('delete_drawing', attachment_id=att[0], card_id=card_id) }}" method="post" class="mt-2">
          <button type="submit" class="btn btn-sm btn-danger">Delete</button>
        </form>
      </div>
    {% else %}
      <p class="text-muted">No drawings attached yet.</p>
    {% endfor %}
  </div>

  <div class="mt-2">
    <form action="{{ url_for('upload_drawing', card_id=card_id) }}" method="post" enctype="multipart/form-data">
      <input type="file" name="file" accept="image/*,.pdf" required>
      <button class="btn btn-sm btn-primary" type="submit">Upload Drawing</button>
    </form>
  </div>
</div>

<!-- Hidden: job_data JSON supplied by backend -->
<script>
  const initialJobData = {{ job_data | tojson | safe }};
  const cardId = {{ card_id }};
  const saveUrl = "{{ url_for('save_card_structure', card_id=card_id) }}";
</script>


<!-- minimal JS helper to render editable structure -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
  function makeParagraphElement(paraObj) {
    // paraObj = {paragraph: "...", steps: [{text:"...", substeps: [...]}, ...] OR steps: ["A...", "B..."]}
    const wrapper = document.createElement('div');
    wrapper.className = 'mb-2 border p-2 bg-light';

    const hdr = document.createElement('div');
    hdr.className = 'd-flex justify-content-between align-items-center mb-2';

    const paraInput = document.createElement('input');
    paraInput.type = 'text';
    paraInput.value = paraObj.paragraph || '';
    paraInput.className = 'form-control me-2';
    paraInput.placeholder = 'Paragraph text';

    const controls = document.createElement('div');
    controls.innerHTML = `<button class="btn btn-sm btn-danger me-1 rmParagraphBtn">Delete</button>
                          <button class="btn btn-sm btn-secondary addStepBtn">+ Step</button>`;

    hdr.appendChild(paraInput);
    hdr.appendChild(controls);
    wrapper.appendChild(hdr);

    const stepsContainer = document.createElement('div');
    stepsContainer.className = 'stepsContainer';

    // normalize steps: allow both string array or objects
    const steps = paraObj.steps || [];
    steps.forEach(s => {
      let stepText = (typeof s === 'string') ? s : (s.text || '');
      const stepEl = document.createElement('div');
      stepEl.className = 'd-flex mb-1';
      stepEl.innerHTML = `<input class="form-control me-2 stepInput" value="${escapeHtml(stepText)}" placeholder="Step text">
                          <button class="btn btn-sm btn-danger rmStepBtn">x</button>`;
      stepsContainer.appendChild(stepEl);
    });

    wrapper.appendChild(stepsContainer);

    // add listeners
    controls.querySelector('.addStepBtn').addEventListener('click', () => {
      const stepEl = document.createElement('div');
      stepEl.className = 'd-flex mb-1';
      stepEl.innerHTML = `<input class="form-control me-2 stepInput" placeholder="Step text">
                          <button class="btn btn-sm btn-danger rmStepBtn">x</button>`;
      stepsContainer.appendChild(stepEl);
      stepEl.querySelector('.rmStepBtn').addEventListener('click', () => stepEl.remove());
    });

    controls.querySelector('.rmParagraphBtn').addEventListener('click', () => wrapper.remove());

    // attach remove for existing steps
    stepsContainer.querySelectorAll('.rmStepBtn').forEach(btn => {
      btn.addEventListener('click', (e) => e.target.closest('div').remove());
    });

    return wrapper;
  }

  // render initial structure
  function renderStructure(data) {
    const container = document.getElementById('structureContainer');
    container.innerHTML = '';
    if (!data || data.length === 0) {
      // show empty message + add paragraph button
      const p = document.createElement('p');
      p.className = 'text-muted';
      p.innerText = 'No paragraphs detected. Add them below.';
      container.appendChild(p);
    }

    data.forEach(p => container.appendChild(makeParagraphElement(p)));
  }

  document.getElementById('addParagraphBtn').addEventListener('click', () => {
    const container = document.getElementById('structureContainer');
    const p = { paragraph: 'New paragraph', steps: [] };
    container.appendChild(makeParagraphElement(p));
  });

  // save structure: collect paragraphs and steps into JSON and POST to backend
  document.getElementById('saveStructureBtn').addEventListener('click', () => {
    const container = document.getElementById('structureContainer');
    const paras = [];
    container.querySelectorAll('div.border').forEach(div => {
      const paraText = div.querySelector('input[type="text"]').value.trim();
      const steps = [];
      div.querySelectorAll('.stepInput').forEach(si => {
        const st = si.value.trim();
        if (st) steps.push(st);
      });
      paras.push({ paragraph: paraText, steps: steps });
    });

    fetch(saveUrl, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({job_data: paras})
    }).then(r => {
      if (r.ok) {
        alert('Structure saved.');
        window.location.href = "{{ url_for('view_card', card_id=card_id) }}";
      } else {
        r.text().then(t => alert('Failed: ' + t));
      }
    });
  });

  function escapeHtml(str) {
    if (!str) return '';
    return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
  }

  // initial render
  renderStructure(initialJobData);
</script>
{% endblock %}
