{% extends "base.html" %}
{% block content %}
  <div class="d-flex justify-content-between">
    <h2>Viewing Card: {{ card_name }}</h2>
    <div>
      <a href="{{ url_for('edit_card', card_id=card_id) }}" class="btn btn-warning">Edit</a>
      <a href="{{ url_for('library') }}" class="btn btn-secondary">Library</a>
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-md-8">
      <h5>PDF</h5>
        {% if pdf_filename %}
          <iframe src="{{ url_for('uploaded_pdf', filename=pdf_filename) }}"
                  style="width:100%;height:600px;border:1px solid #ccc;"></iframe>
        {% else %}
          <p class="text-muted">No PDF attached for this card.</p>
        {% endif %}
    </div>

    <div class="col-md-4">
      <h5>Warnings</h5>
<div style="max-height:180px; overflow-y:auto;">
  {% if warnings %}
    {% for sentence in warnings.split('.') %}
      {% set sentence = sentence.strip() %}
      {% if sentence %}
        <div class="alert alert-danger py-1 mb-1">{{ sentence }}.</div>
      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-muted">No warnings.</p>
  {% endif %}
</div>

<h5 class="mt-3">Cautions</h5>
<div style="max-height:180px; overflow-y:auto;">
  {% if cautions %}
    {% for sentence in cautions.split('.') %}
      {% set sentence = sentence.strip() %}
      {% if sentence %}
        <div class="alert alert-warning py-1 mb-1">{{ sentence }}.</div>
      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-muted">No cautions.</p>
  {% endif %}
</div>

<h5 class="mt-3">Notes</h5>
<div style="max-height:180px; overflow-y:auto;">
  {% if notes %}
    {% for sentence in notes.split('.') %}
      {% set sentence = sentence.strip() %}
      {% if sentence %}
        <div class="alert alert-info py-1 mb-1">{{ sentence }}.</div>
      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-muted">No notes.</p>
  {% endif %}
</div>


    </div>
  </div>

  <div class="mt-4">
    <h4>Parsed Structure</h4>
    <table class="table table-bordered">
      <thead class="table-dark"><tr><th>Paragraph</th><th>Step</th></tr></thead>
      <tbody>
        {% for row in table_data %}
          <tr>
            <td>{{ row[0] }}</td>
            <td>{{ row[1] }}</td>
          </tr>
        {% else %}
          <tr><td colspan="2" class="text-muted">No paragraphs/steps available. Edit the card to add structure.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="mt-3">
    <h5>Attached Drawings</h5>
    <div class="row">
      {% for att in attachments %}
        <div class="col-md-3 mb-3">
          {% if att[1].lower().endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
            <img src="{{ url_for('uploaded_drawing', filename=att[1]) }}" class="img-fluid">
          {% else %}
            <a href="{{ url_for('uploaded_drawing', filename=att[1]) }}" target="_blank">{{ att[1] }}</a>
          {% endif %}
        </div>
      {% endfor %}
    </div>
  </div>
{% endblock %}

 


<script>
  async function logProgress(data) {
  const res = await fetch("/api/progress", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data)
  });
  if (!res.ok) alert("Failed to log progress.");
}

document.querySelectorAll(".mark-done").forEach(btn => {
  btn.addEventListener("click", async () => {
    const tech = prompt("Technician name:");
    const rank = prompt("Rank:");
    await logProgress({
      type: "paragraph",
      paragraph: btn.dataset.para,
      status: "done",
      technician: tech,
      rank: rank
    });
    btn.classList.add("btn-success");
  });
});

document.querySelectorAll(".mark-int").forEach(btn => {
  btn.addEventListener("click", async () => {
    const tech = prompt("Technician name:");
    const rank = prompt("Rank:");
    const reason = prompt("Reason for interruption:");
    await logProgress({
      type: "paragraph",
      paragraph: btn.dataset.para,
      status: "interrupted",
      technician: tech,
      rank: rank,
      reason: reason
    });
    btn.classList.add("btn-danger");
  });
});

</script>
