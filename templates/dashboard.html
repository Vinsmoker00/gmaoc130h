{% extends "base.html" %}
{% block content %}
<div class="container my-4">
  <h2 class="mb-4">üìä Periodic Visit Dashboard</h2>

  {% if visits %}
    <div class="row">
      {% for v in visits %}
      <div class="col-md-4 mb-4">
        <div class="card shadow-sm vp-card" data-visit-id="{{ v.id }}">
          <div class="card-header d-flex justify-content-between align-items-center">
            <strong>{{ v.aircraft }}</strong>
            <span class="badge bg-info">{{ v.type }}</span>
          </div>
          <div class="card-body">
            <p class="mb-1"><b>Start:</b> {{ v.start_date }}</p>
            <p class="mb-1"><b>Status:</b> {{ v.status }}</p>
            <p class="mb-1"><b>Progress:</b> {{ v.pct }}%</p>
            <div class="progress mb-2" style="height: 8px;">
              <div class="progress-bar bg-success" style="width: {{ v.pct }}%"></div>
            </div>
            <button class="btn btn-primary btn-sm view-details w-100">View Details</button>
            <button class="btn btn-danger btn-sm mt-2 delete-vp w-100">üóë Delete</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">No ongoing VPs found.</div>
  {% endif %}

  <hr>
  <div id="vp-details" class="mt-4" style="display:none;">
    <h4>Details for <span id="vp-aircraft"></span></h4>
    <p><b>Type:</b> <span id="vp-type"></span> | <b>Start:</b> <span id="vp-start"></span></p>

    <div id="cards-container"></div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // üîπ Expand VP details
  document.querySelectorAll(".view-details").forEach(btn => {
    btn.addEventListener("click", async function() {
      const card = this.closest(".vp-card");
      const vid = card.dataset.visitId;
      const detailSection = document.getElementById("vp-details");
      const cardsContainer = document.getElementById("cards-container");
      cardsContainer.innerHTML = "";
      detailSection.style.display = "block";
      detailSection.scrollIntoView({ behavior: "smooth" });

      try {
        const resp = await fetch(`/api/visit/${vid}/detail`);
        if (!resp.ok) throw new Error("Failed to load details");
        const data = await resp.json();

        // Fill header info
        document.getElementById("vp-aircraft").textContent = data.visit.aircraft;
        document.getElementById("vp-type").textContent = data.visit.type;
        document.getElementById("vp-start").textContent = data.visit.start_date;

        if (!data.cards || data.cards.length === 0) {
          cardsContainer.innerHTML = `<div class="alert alert-warning">No job cards found for this VP.</div>`;
          return;
        }

        // Build job cards view
        data.cards.forEach(vc => {
          const cardDiv = document.createElement("div");
          cardDiv.className = "card mb-3 shadow-sm";
          cardDiv.innerHTML = `
            <div class="card-header d-flex justify-content-between">
              <strong>${vc.filename}</strong>
              <span class="badge bg-secondary">${vc.status}</span>
            </div>
            <div class="card-body">
              <p><b>Estimated:</b> ${vc.estimated_hours || 'N/A'} hrs</p>
              <p><b>Started:</b> ${vc.started_at || '-'} | <b>Completed:</b> ${vc.completed_at || '-'}</p>

              <button class="btn btn-success btn-sm mark-done me-2">‚úÖ Mark Done</button>
              <button class="btn btn-warning btn-sm interrupt">‚ö†Ô∏è Interrupt</button>

              <div class="mt-3">
                <h6>Paragraphs & Steps</h6>
                ${vc.job_data.map((p, pi) => `
                  <div class="border p-2 mb-2">
                    <b>${p.paragraph}</b>
                    ${p.steps.map((s, si) => `
                      <div class="ms-3">
                        ${s}
                        <button class="btn btn-outline-success btn-sm mark-step" data-p="${pi}" data-s="${si}" data-vcid="${vc.visit_card_id}" data-vid="${data.visit.id}">‚úì</button>
                        <button class="btn btn-outline-danger btn-sm interrupt-step" data-p="${pi}" data-s="${si}" data-vcid="${vc.visit_card_id}" data-vid="${data.visit.id}">!</button>
                      </div>
                    `).join('')}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          cardsContainer.appendChild(cardDiv);
        });

      } catch (err) {
        cardsContainer.innerHTML = `<div class="alert alert-danger">${err}</div>`;
      }
    });
  });

  // üîπ Delete VP with confirmation
  document.querySelectorAll(".delete-vp").forEach(btn => {
    btn.addEventListener("click", async function() {
      const card = this.closest(".vp-card");
      const vid = card.dataset.visitId;
      if (!confirm("Are you sure you want to delete this VP?")) return;
      try {
        const resp = await fetch(`/api/visit/${vid}/delete`, { method: "DELETE" });
        if (!resp.ok) throw new Error("Delete failed");
        location.reload();
      } catch (err) {
        alert("‚ùå Failed to delete VP: " + err);
      }
    });
  });

  // üîπ Handle marking a step done
  document.addEventListener("click", async function(e) {
    if (e.target.classList.contains("mark-step")) {
      const vid = e.target.dataset.vid;
      const vcid = e.target.dataset.vcid;
      const pi = e.target.dataset.p;
      const si = e.target.dataset.s;
      const tech = prompt("Technician name?");
      const rank = prompt("Rank?");
      const notes = prompt("Notes (optional):");
      await fetch(`/api/visit/${vid}/card/${vcid}/paragraph/done`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ paragraph_index: pi, step_index: si, technician_name: tech, technician_rank: rank, notes })
      });
      alert("‚úÖ Step marked as done!");
    }
  });

  // üîπ Handle interruption
  document.addEventListener("click", async function(e) {
    if (e.target.classList.contains("interrupt-step")) {
      const vid = e.target.dataset.vid;
      const vcid = e.target.dataset.vcid;
      const pi = e.target.dataset.p;
      const si = e.target.dataset.s;
      const tech = prompt("Technician name?");
      const rank = prompt("Rank?");
      const type = prompt("Interruption type? (material/personnel/other)");
      const reason = prompt("Reason?");
      await fetch(`/api/visit/${vid}/card/${vcid}/paragraph/interruption`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          paragraph_index: pi, step_index: si,
          technician_name: tech, technician_rank: rank,
          interruption_type: type, interruption_reason: reason
        })
      });
      alert("‚ö†Ô∏è Step interruption recorded.");
    }
  });
});
</script>
{% endblock %}
